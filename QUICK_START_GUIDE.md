# ç”µæœºæ§åˆ¶åŠŸèƒ½å¿«é€Ÿå¼€å§‹æŒ‡å—

## 5åˆ†é’Ÿå¿«é€Ÿé…ç½®

### 1. å‰ç½®æ£€æŸ¥
- âœ… RabbitMQå·²å®‰è£…ä¸”è¿è¡Œä¸­
- âœ… RabbitMQå»¶è¿Ÿæ’ä»¶å·²å®‰è£…ï¼ˆå‚è€ƒRABBITMQ_DELAYED_PLUGIN_SETUP.mdï¼‰
- âœ… åº”ç”¨å·²å¯åŠ¨ï¼Œä¾èµ–å·²æ›´æ–°

### 2. é…ç½®ç”µæœºæ§åˆ¶è§„åˆ™

#### é€‰é¡¹Aï¼šæ¸©åº¦è‡ªåŠ¨æ§åˆ¶ï¼ˆæœ€å¸¸ç”¨ï¼‰
```sql
-- æ›´æ–°è®¾å¤‡d002çš„é£æœº1ä¸ºæ¸©åº¦æ§åˆ¶
UPDATE motor_fan 
SET 
    auto_mode = 1,              -- è‡ªåŠ¨æ¨¡å¼
    control_mode = 1,           -- æ¸©åº¦æ§åˆ¶
    probe_sensor_id = 1,        -- ä½¿ç”¨ä¼ æ„Ÿå™¨1
    temp_upper = 38.00,         -- é«˜äº38Â°Cå¯åŠ¨
    temp_lower = 30.00          -- ä½äº30Â°Cåœæ­¢
WHERE device_num = 'mt1' AND device_id = 2;
```

#### é€‰é¡¹Bï¼šå®šæ—¶æ§åˆ¶ï¼ˆæ—©æ™šé€šé£ï¼‰
```sql
-- æ›´æ–°è®¾å¤‡d002çš„é£æœº2ä¸ºå®šæ—¶æ§åˆ¶
UPDATE motor_fan 
SET 
    auto_mode = 1,              -- è‡ªåŠ¨æ¨¡å¼
    control_mode = 5,           -- å®šæ—¶æ§åˆ¶
    timer1_enabled = 1,         -- æ—©ä¸Šæ—¶æ®µ
    timer1_start_time = '06:00',
    timer1_end_time = '09:00',
    timer2_enabled = 1,         -- æ™šä¸Šæ—¶æ®µ
    timer2_start_time = '17:00',
    timer2_end_time = '20:00'
WHERE device_num = 'mt2' AND device_id = 2;
```

#### é€‰é¡¹Cï¼šæ‰‹åŠ¨æ§åˆ¶
```sql
-- å¼ºåˆ¶å…³é—­
UPDATE motor_fan SET auto_mode = 3 WHERE id = 95;

-- å¼ºåˆ¶å¼€å¯
UPDATE motor_fan SET auto_mode = 2 WHERE id = 95;

-- æ¢å¤è‡ªåŠ¨
UPDATE motor_fan SET auto_mode = 1 WHERE id = 95;
```

### 3. å‘é€MQTTæµ‹è¯•æ¶ˆæ¯

ä½¿ç”¨MQTTå®¢æˆ·ç«¯ï¼ˆå¦‚MQTT.fxæˆ–mosquitto_pubï¼‰ï¼š

```
Topic: device/d002
Message:
{
    "id": "d002",
    "ts1": 35.5,
    "ts2": 34.2,
    "ts3": 33.1,
    "ts4": 32.8,
    "mt1": 0,
    "mt2": 0,
    "mt3": 0,
    "mt4": 0,
    "mt5": 0,
    "mt6": 0,
    "mt7": 0,
    "mt8": 0,
    "mt9": 0,
    "mt10": 0,
    "imt1": 0,
    "imt2": 0
}
```

### 4. éªŒè¯ç»“æœ

#### æ£€æŸ¥åº”ç”¨æ—¥å¿—
```bash
tail -f logs/application.log | grep -E "ç”µæœº|æ§åˆ¶|æ¶ˆæ¯"
```

å…³é”®æ—¥å¿—ï¼š
- âœ… "å¤„ç†ç”µæœºæ§åˆ¶æ¶ˆæ¯" - æ¶ˆæ¯å·²æ¥æ”¶
- âœ… "ç”µæœºæ§åˆ¶æ¶ˆæ¯å¤„ç†æˆåŠŸ" - çŠ¶æ€å·²æ›´æ–°
- âœ… "å‘é€å»¶æ—¶ç”µæœºæ§åˆ¶æ¶ˆæ¯" - å»¶æ—¶æ¶ˆæ¯å·²å‘é€

#### æ£€æŸ¥æ•°æ®åº“
```sql
-- æŸ¥çœ‹ç”µæœºè¿è¡ŒçŠ¶æ€æ˜¯å¦æ›´æ–°
SELECT id, fan_name, is_running, control_mode, auto_mode 
FROM motor_fan 
WHERE device_id = 2 
ORDER BY id;
```

#### æ£€æŸ¥RabbitMQé˜Ÿåˆ—
1. è®¿é—® http://localhost:15672
2. è¿›å…¥ Queues æ ‡ç­¾
3. æŸ¥çœ‹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ•°é‡

## å¸¸è§æ§åˆ¶åœºæ™¯

### åœºæ™¯1ï¼šé«˜æ¸©å¯åŠ¨å†·å´
```
é…ç½®ï¼š
- control_mode = 1ï¼ˆæ¸©åº¦æ§åˆ¶ï¼‰
- temp_upper = 38ï¼ˆå¯åŠ¨æ¸©åº¦ï¼‰
- temp_lower = 30ï¼ˆåœæ­¢æ¸©åº¦ï¼‰

è¡Œä¸ºï¼š
å½“å‰æ¸©åº¦ < 30 â†’ é£æœºå…³é—­ âŒ
å½“å‰æ¸©åº¦ >= 38 â†’ é£æœºå¯åŠ¨ âœ…
30 <= å½“å‰æ¸©åº¦ < 38 â†’ ä¿æŒå½“å‰çŠ¶æ€
```

### åœºæ™¯2ï¼šé«˜æ¹¿å¯åŠ¨é™¤æ¹¿
```
é…ç½®ï¼š
- control_mode = 3ï¼ˆæ¹¿åº¦æ§åˆ¶ï¼‰
- humidity_upper = 75ï¼ˆå¯åŠ¨æ¹¿åº¦%ï¼‰
- humidity_lower = 45ï¼ˆåœæ­¢æ¹¿åº¦%ï¼‰

è¡Œä¸ºï¼š
ä¸æ¸©åº¦æ§åˆ¶ç±»ä¼¼ï¼ŒåŸºäºæ¹¿åº¦å€¼
```

### åœºæ™¯3ï¼šé«˜æµ“åº¦å¯åŠ¨æ’æ°”
```
é…ç½®ï¼š
- control_mode = 4ï¼ˆæ°”ä½“æ§åˆ¶ï¼‰
- gas_upper = 3000ï¼ˆå¯åŠ¨æµ“åº¦ppmï¼‰
- gas_lower = 1000ï¼ˆåœæ­¢æµ“åº¦ppmï¼‰

è¡Œä¸ºï¼š
ä¸æ¸©åº¦æ§åˆ¶ç±»ä¼¼ï¼ŒåŸºäºæ°”ä½“æµ“åº¦å€¼
```

### åœºæ™¯4ï¼šå›ºå®šæ—¶é—´è¡¨æ§åˆ¶
```
é…ç½®ï¼š
- control_mode = 5ï¼ˆå®šæ—¶æ§åˆ¶ï¼‰
- timer1_enabled = 1
- timer1_start_time = '08:00'
- timer1_end_time = '17:00'
- timer2_enabled = 1
- timer2_start_time = '20:00'
- timer2_end_time = '23:00'

è¡Œä¸ºï¼š
08:00 - 17:00 â†’ é£æœºå¼€å¯ âœ…
17:00 - 20:00 â†’ é£æœºå…³é—­ âŒ
20:00 - 23:00 â†’ é£æœºå¼€å¯ âœ…
23:00 - 08:00 â†’ é£æœºå…³é—­ âŒ
```

### åœºæ™¯5ï¼šè·¨è¶Šåˆå¤œçš„æ—¶é—´è¡¨
```
é…ç½®ï¼š
- timer_start_time = '22:00'
- timer_end_time = '06:00'

è¡Œä¸ºï¼š
22:00 - 23:59 â†’ é£æœºå¼€å¯ âœ…
00:00 - 05:59 â†’ é£æœºå¼€å¯ âœ…
06:00 - 21:59 â†’ é£æœºå…³é—­ âŒ
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šç”µæœºçŠ¶æ€æ²¡æœ‰æ›´æ–°
```
æ£€æŸ¥æ¸…å•ï¼š
1. âœ“ æ£€æŸ¥MQTTæ¶ˆæ¯æ˜¯å¦åˆ°è¾¾ï¼ˆæŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼‰
2. âœ“ æ£€æŸ¥motor_fanè¡¨ä¸­auto_modeæ˜¯å¦ä¸º1ï¼ˆè‡ªåŠ¨ï¼‰
3. âœ“ æ£€æŸ¥control_modeæ˜¯å¦æœ‰æ•ˆï¼ˆ1-5ï¼‰
4. âœ“ æ£€æŸ¥ç›¸åº”çš„é˜ˆå€¼é…ç½®æ˜¯å¦å®Œæ•´
5. âœ“ æ£€æŸ¥ä¼ æ„Ÿå™¨å€¼æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°æ®
```

### é—®é¢˜2ï¼šå»¶è¿Ÿæ¶ˆæ¯ä¸ç”Ÿæ•ˆ
```
æ£€æŸ¥æ¸…å•ï¼š
1. âœ“ RabbitMQå»¶è¿Ÿæ’ä»¶æ˜¯å¦å·²å¯ç”¨
   rabbitmq-plugins list | grep delayed
2. âœ“ æ£€æŸ¥RabbitMQæ˜¯å¦é‡æ–°å¯åŠ¨è¿‡
3. âœ“ åœ¨RabbitMQç®¡ç†ç•Œé¢æ£€æŸ¥äº¤æ¢æœºç±»å‹
   åº”è¯¥æ˜¯ "x-delayed-message" ç±»å‹
4. âœ“ æ£€æŸ¥æ¶ˆæ¯çš„delayTimeæ˜¯å¦ > 0
```

### é—®é¢˜3ï¼šRabbitMQè¿æ¥å¤±è´¥
```
æ£€æŸ¥æ¸…å•ï¼š
1. âœ“ RabbitMQæœåŠ¡æ˜¯å¦è¿è¡Œä¸­
   systemctl status rabbitmq-server
2. âœ“ RabbitMQåœ°å€å’Œç«¯å£é…ç½®æ˜¯å¦æ­£ç¡®
   spring.rabbitmq.host=192.168.56.128
   spring.rabbitmq.port=5672
3. âœ“ é˜²ç«å¢™æ˜¯å¦å¼€æ”¾5672ç«¯å£
   sudo firewall-cmd --add-port=5672/tcp
4. âœ“ ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
   é»˜è®¤ï¼šguest/guest
```

### é—®é¢˜4ï¼šåº”ç”¨å¯åŠ¨å¤±è´¥
```
æ£€æŸ¥æ¸…å•ï¼š
1. âœ“ pom.xmlä¸­æ˜¯å¦æ·»åŠ äº†spring-boot-starter-amqp
2. âœ“ application.propertiesä¸­RabbitMQé…ç½®æ˜¯å¦å®Œæ•´
3. âœ“ æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
4. âœ“ æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
   java -jar demo.jar > app.log 2>&1
```

## å‘½ä»¤è¡Œå¿«é€Ÿæµ‹è¯•

### æ–¹æ³•1ï¼šä½¿ç”¨mosquitto_pubå‘é€MQTTæ¶ˆæ¯
```bash
mosquitto_pub -h 192.168.56.128 -t device/d002 -m '{
  "id": "d002",
  "ts1": 39.0,
  "ts2": 34.0,
  "ts3": 33.0,
  "ts4": 32.0,
  "mt1": 0,
  "mt2": 0,
  "mt3": 0,
  "mt4": 0,
  "mt5": 0,
  "mt6": 0,
  "mt7": 0,
  "mt8": 0,
  "mt9": 0,
  "mt10": 0,
  "imt1": 0,
  "imt2": 0
}'
```

### æ–¹æ³•2ï¼šä½¿ç”¨curléªŒè¯åº”ç”¨å¥åº·çŠ¶æ€
```bash
curl -X GET http://localhost:8080/health
```

### æ–¹æ³•3ï¼šæ£€æŸ¥RabbitMQé˜Ÿåˆ—çŠ¶æ€
```bash
# è¿›å…¥RabbitMQå®¹å™¨
docker exec -it rabbitmq bash

# åˆ—å‡ºæ‰€æœ‰é˜Ÿåˆ—
rabbitmqctl list_queues

# åˆ—å‡ºç»‘å®šå…³ç³»
rabbitmqctl list_bindings
```

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|-----|------|
| MQTTæ¶ˆæ¯å¤„ç†å»¶è¿Ÿ | < 100ms | ä»æ¥æ”¶åˆ°å¤„ç† |
| å»¶æ—¶æ¶ˆæ¯ç²¾åº¦ | Â±100ms | å—ç³»ç»Ÿè°ƒåº¦å½±å“ |
| é˜Ÿåˆ—ååé‡ | 1000+ msg/s | RabbitMQèƒ½åŠ› |
| æ•°æ®åº“æ›´æ–°å»¶è¿Ÿ | < 50ms | å•æ¡æ›´æ–° |
| æœ€å¤§å»¶è¿Ÿæ—¶é—´ | 24.8å¤© | RabbitMQé™åˆ¶ |

## ä¸‹ä¸€æ­¥

1. **è°ƒæ•´é˜ˆå€¼** - æ ¹æ®å®é™…å…»æ®–ç¯å¢ƒè°ƒæ•´å„æ¨¡å¼çš„é˜ˆå€¼
2. **æ·»åŠ å‘Šè­¦** - å½“ç”µæœºæ§åˆ¶å¤±è´¥æ—¶å‘é€å‘Šè­¦
3. **å†å²åˆ†æ** - è®°å½•æ‰€æœ‰æ§åˆ¶äº‹ä»¶è¿›è¡Œåˆ†æ
4. **ç§»åŠ¨ç«¯é›†æˆ** - åœ¨å‰ç«¯Appä¸­æ˜¾ç¤ºç”µæœºæ§åˆ¶çŠ¶æ€
5. **æ‰©å±•åœºæ™¯** - æ·»åŠ æ›´å¤æ‚çš„æ§åˆ¶é€»è¾‘å’Œè”åŠ¨è§„åˆ™

## å…³é”®æ–‡æ¡£

- ğŸ“– [ç”µæœºæ§åˆ¶å®ç°æ€»ç»“](MOTOR_CONTROL_IMPLEMENTATION_SUMMARY.md) - è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
- ğŸ“– [RabbitMQå»¶è¿Ÿæ’ä»¶å®‰è£…](RABBITMQ_DELAYED_PLUGIN_SETUP.md) - æ’ä»¶å®‰è£…æŒ‡å—
- ğŸ“– [æ•°æ®åº“è®¾è®¡](sql/iot_system.sql) - å®Œæ•´çš„è¡¨ç»“æ„å®šä¹‰

## è·å–å¸®åŠ©

é‡åˆ°é—®é¢˜ï¼ŸæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¯Šæ–­ï¼š

1. **æŸ¥çœ‹æ—¥å¿—** - åº”ç”¨æ—¥å¿—å¾€å¾€åŒ…å«é—®é¢˜çš„çº¿ç´¢
2. **æ£€æŸ¥é…ç½®** - ç¡®ä¿æ‰€æœ‰é…ç½®é¡¹éƒ½å·²æ­£ç¡®è®¾ç½®
3. **éªŒè¯æ•°æ®** - ç¡®ä¿motor_fanè¡¨çš„é…ç½®æ­£ç¡®
4. **æµ‹è¯•MQTT** - ç¡®ä¿MQTTæ¶ˆæ¯æ ¼å¼æ­£ç¡®
5. **æ£€æŸ¥RabbitMQ** - ç¡®ä¿æ¶ˆæ¯å·²è¿›å…¥é˜Ÿåˆ—

## æ”¯æŒè”ç³»

å¦‚éœ€å¸®åŠ©ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
- åº”ç”¨æ—¥å¿—ï¼ˆæœ€å50è¡Œï¼‰
- RabbitMQé˜Ÿåˆ—çŠ¶æ€
- motor_fanè¡¨çš„ç›¸å…³é…ç½®
- MQTTæ¶ˆæ¯å†…å®¹
- é¢„æœŸè¡Œä¸ºå’Œå®é™…è¡Œä¸ºçš„å¯¹æ¯”
